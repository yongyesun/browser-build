name: build
env:
    TZ: Asia/Shanghai

on:
  workflow_dispatch:
    inputs:
      ssh:
        description: 'SSH connection to Actions'
        required: false
        default: 'false'

jobs:
  build:
    runs-on: ubuntu-20.04
    permissions:
      contents: write

    steps:
    - name: Maximize build space
      uses: easimon/maximize-build-space@master
      with:
        root-reserve-mb: 1536
        swap-size-mb: 1024
        remove-dotnet: 'true'
        remove-android: 'true'
        remove-haskell: 'true'
        remove-codeql: 'true'
        remove-docker-images: 'true'

    - uses: actions/checkout@v2
    - name: env
      run: |
        echo "START_TIME=$(date '+%s')" >> $GITHUB_ENV
        mkdir -p "$PWD/run"
        echo "FLAG_STOP=$PWD/run/ninjaStop" >> $GITHUB_ENV
        echo "ROOT=$PWD" >> $GITHUB_ENV

    - run: lscpu
    - run: df -h
    - run: chmod -R a+x $ROOT/script/
    - run: $ROOT/script/create_ccache_config.sh    
    - run: $ROOT/script/maximize_build_space.sh
    - run: df -h
    - run: $ROOT/script/download_depot.sh        
    - run: $ROOT/script/download_src.sh    
    - run: $ROOT/script/gen.sh
    - run: $ROOT/script/auto_kill.sh
    - run: df -h
    
    - name: SSH connection to Actions
      uses: P3TERX/ssh2actions@v1.0.0
      if: (github.event.inputs.ssh == 'true' && github.event.inputs.ssh  != 'false') || contains(github.event.action, 'ssh')
      env:
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
    
    - run: $ROOT/script/build_step.sh
    - run: df -h
    - run: ccache -s
    - run: killall sleep && cp -r $ROOT/chromium/src/out/ $ROOT/out

    - name: 提交更改
      run: |
        cd $ROOT
        git config core.ignorecase false
        git config --local user.email "actions@github.com"
        git config --local user.name "GitHub Actions"
        git add "./out"
        git commit -m "$(date '+%Y-%m-%d %H:%M:%S')更新" || echo no change,
        git pull origin main
        git push origin main
